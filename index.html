<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | INTI International College Penang</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        /* White page and container so there's never a black backdrop */
        html, body {
            height: 100%;
            margin: 0;
            background: #ffffff;
        }

        #unity-container {
            position: relative;
            min-height: 100vh;
            background: #ffffff;
        }

        /* Canvas: transparent so the page background shows while loading */
        #unity-canvas {
            background: transparent !important;
            outline: none;
            display: block;
        }

        /* Center the loader above the canvas with a high z-index */
        #unity-loading-bar {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            pointer-events: none;
        }
        /* Simple, always-visible progress bar (independent of TemplateData images) */
        #unity-progress-bar-empty {
            width: min(420px, 80vw);
            height: 10px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(0,0,0,.12);
        }

        #unity-progress-bar-full {
            height: 100%;
            width: 0%;
            background: #e01e37; /* progress color */
            transition: width .12s linear;
        }

        /* Keep footer/warnings positioned like the template expects */
        #unity-warning, #unity-footer {
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width="1400" height="880" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">INTI International College Penang</div>
        </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-check-compat.js"></script>

    <!-- For GitHub (prod), this is generated by your workflow -->
    <script src="firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            /* ---------- Firebase init (uses injected FIREBASE_CONFIG) ---------- */
            if (window.FIREBASE_CONFIG) {
                try {
                    firebase.initializeApp(window.FIREBASE_CONFIG);
                    console.log('Firebase initialized');
                    if (window.APP_CHECK_SITE_KEY) {
                        firebase.appCheck().activate(window.APP_CHECK_SITE_KEY, true);
                        console.log('App Check activated');
                    }
                } catch (e) { console.error('Firebase init error:', e); }
            }
            // (for local dev, you can comment the line above and paste your inline firebaseConfig here)

            /* ---------- (Your existing Firebase helpers â€” unchanged) ---------- */
            function normalizeScenes(root) {
                const out = [];
                if (!root || typeof root !== "object") return out;
                for (const building of Object.keys(root)) {
                    const bObj = root[building];
                    if (!bObj || typeof bObj !== "object") continue;
                    const childKeys = Object.keys(bObj);
                    if (childKeys.length === 0) continue;
                    const firstChild = bObj[childKeys[0]];
                    const hasLevels = firstChild && typeof firstChild === "object" &&
                        !("SceneTitle" in firstChild) && !("ImageUrl" in firstChild);
                    if (hasLevels) {
                        for (const levelName of childKeys) {
                            const levelObj = bObj[levelName];
                            if (!levelObj || typeof levelObj !== "object") continue;
                            for (const itemKey of Object.keys(levelObj)) {
                                const item = levelObj[itemKey] || {};
                                const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                                if (k && u) out.push({ Id: String(itemKey), SceneTitle: String(t || ""), S3Key: String(k), ImageUrl: String(u), Building: String(building), Level: String(levelName) });
                            }
                        }
                    } else {
                        for (const itemKey of childKeys) {
                            const item = bObj[itemKey] || {};
                            const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                            if (k && u) out.push({ Id: String(itemKey), SceneTitle: String(t || ""), S3Key: String(k), ImageUrl: String(u), Building: String(building), Level: "" });
                        }
                    }
                }
                out.sort((a, b) => (a.Building || "").localeCompare(b.Building || "") || (a.Level || "").localeCompare(b.Level || "") || (a.SceneTitle || "").localeCompare(b.SceneTitle || ""));
                return out;
            }

            async function fetchScenesArray() {
                try {
                    const snap = await firebase.database().ref("Scenes").get();
                    if (!snap.exists()) return [];
                    return normalizeScenes(snap.val());
                } catch (err) { console.error("[index] Firebase read failed:", err); return []; }
            }

            function sendScenesToUnity(unityInstance, scenesArray) {
                try {
                    const payload = JSON.stringify(scenesArray);
                    unityInstance.SendMessage("FirebaseBridge", "OnPreloadDataReceived", payload);
                } catch (err) { console.error("[index] SendMessage failed:", err); }
            }

            /* ---------- Unity boot ---------- */
            const container = document.querySelector("#unity-container");
            const canvas = document.querySelector("#unity-canvas");
            const loadingBar = document.querySelector("#unity-loading-bar");
            const progressBarFull = document.querySelector("#unity-progress-bar-full");
            const fullscreenButton = document.querySelector("#unity-fullscreen-button");
            const warningBanner = document.querySelector("#unity-warning");

            function unityShowBanner(msg, type) {
                function updateBannerVisibility() {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                }
                var div = document.createElement('div');
                div.innerHTML = msg;
                warningBanner.appendChild(div);
                if (type == 'error') div.style = 'background: red; padding: 10px;';
                else {
                    if (type == 'warning') div.style = 'background: #fff3cd; padding: 10px;';
                    setTimeout(function () { warningBanner.removeChild(div); updateBannerVisibility(); }, 5000);
                }
                updateBannerVisibility();
            }

            // Mobile viewport
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                const meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.head.appendChild(meta);
                container.className = "unity-mobile";
                canvas.className = "unity-mobile";
            }

            // ---------- point to your newbuild bundle (change to "output" for local/dev) ----------
            const buildUrl = "Build";
            const buildName = "newbuild";                // <-- GitHub/prod
            // const buildName = "output";               // <-- local/dev

            const loaderUrl = `${buildUrl}/${buildName}.loader.js?v=8`;  // cache-bust on rebuild
            const config = {
                dataUrl: `${buildUrl}/${buildName}.data.unityweb`,
                frameworkUrl: `${buildUrl}/${buildName}.framework.js.unityweb`,
                codeUrl: `${buildUrl}/${buildName}.wasm.unityweb`,
                streamingAssetsUrl: "StreamingAssets",
                companyName: "INTI College",
                productName: "INTI Virtual Tour",
                productVersion: "1.0",
                devicePixelRatio: Math.min(1.5, window.devicePixelRatio || 1),
                decompressionFallback: true,
                webglContextAttributes: { alpha: true },
                showBanner: unityShowBanner
            };

            // Show loader immediately
            loadingBar.style.display = "flex";

            // Start fetching Firebase data in parallel (so the loader animates right away)
            const firebasePromise = fetchScenesArray()
                .then(arr => { console.log("[firebase] scenes fetched:", arr.length); return arr; });

            // Load Unity
            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = (100 * progress) + "%";
                }).then(async (unityInstance) => {

                    // Fullscreen button
                    if (fullscreenButton) fullscreenButton.onclick = () => { unityInstance.SetFullscreen(1); };

                    // Deliver Firebase data once both are ready (with small retry in case GO not ready)
                    const scenes = await firebasePromise;
                    const payload = JSON.stringify(scenes || []);
                    let delivered = false;
                    for (let i = 0; i < 20; i++) { // retry ~10s total
                        try {
                            unityInstance.SendMessage("FirebaseBridge", "OnPreloadDataReceived", payload);
                            delivered = true;
                            console.log("[index] scenes payload delivered to Unity");
                            break;
                        } catch (e) {
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }
                    if (!delivered) {
                        console.warn("[index] Could not deliver scenes to FirebaseBridge after retries.");
                    }

                    // Hide loader only when Unity is ready
                    loadingBar.style.display = "none";

                }).catch((message) => {
                    loadingBar.style.display = "none";
                    alert(message);
                });
            };
            document.body.appendChild(script);
    </script>
</body>
</html>
