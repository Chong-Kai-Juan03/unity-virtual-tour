<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | INTI International College Penang</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #unity-container {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        #unity-canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
            outline: none;
            background: #000;
        }

        #unity-loading-bar, #unity-footer, #unity-warning {
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"> </div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">INTI International College Penang</div>
        </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="./firebase-config.js"></script>

    <!-- Unity Loader must be loaded BEFORE we call createUnityInstance -->
    <script src="./Build/unity-virtual-tour.loader.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async function () {
        console.log("Page loaded, initializing Unity and Firebase...");

        // --- Firebase should already be initialized from firebase-config.js ---

        // If a building has no levels, use this value
        const LEVEL_FOR_BUILDINGS_WITHOUT_LEVELS = "N/A";

        // [{ Id, SceneTitle, S3Key, ImageUrl, Building, Level }, ...]
        function normalizeScenes(root) {
            const out = [];
            if (!root || typeof root !== "object") return out;

            for (const building of Object.keys(root)) {
                const bObj = root[building];
                if (!bObj || typeof bObj !== "object") continue;

                const childKeys = Object.keys(bObj);
                if (childKeys.length === 0) continue;

                const firstChild = bObj[childKeys[0]];
                const hasLevels = firstChild && typeof firstChild === "object" &&
                    !("SceneTitle" in firstChild) && !("ImageUrl" in firstChild);

                if (hasLevels) {
                    // Buildings with levels (e.g., Inti-Penang)
                    for (const levelName of childKeys) {
                        const levelObj = bObj[levelName];
                        if (!levelObj || typeof levelObj !== "object") continue;

                        for (const itemKey of Object.keys(levelObj)) {
                            const item = levelObj[itemKey] || {};
                            const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                            if (k && u) {
                                out.push({
                                    Id: String(itemKey),
                                    SceneTitle: t ? String(t) : "",
                                    S3Key: String(k),
                                    ImageUrl: String(u),
                                    Building: String(building),
                                    Level: String(levelName)
                                });
                            }
                        }
                    }
                } else {
                    // Buildings without levels (e.g., USAINS)
                    for (const itemKey of childKeys) {
                        const item = bObj[itemKey] || {};
                        const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                        if (k && u) {
                            out.push({
                                Id: String(itemKey),
                                SceneTitle: t ? String(t) : "",
                                S3Key: String(k),
                                ImageUrl: String(u),
                                Building: String(building),
                                Level: ""
                            });
                        }
                    }
                }
            }

            out.sort((a, b) =>
                (a.Building || "").localeCompare(b.Building || "") ||
                (a.Level || "").localeCompare(b.Level || "") ||
                (a.SceneTitle || "").localeCompare(b.SceneTitle || "")
            );

            console.log("[index] Flattened scenes:", out);
            return out;
        }

        async function fetchScenesArray() {
            try {
                const snap = await firebase.database().ref("Scenes").get();
                if (!snap.exists()) {
                    console.warn("No data found at 'Scenes' reference");
                    return [];
                }
                return normalizeScenes(snap.val());
            } catch (err) {
                console.error("[index] Firebase read failed:", err);
                return [];
            }
        }

        function sendScenesToUnity(unityInstance, scenesArray) {
            try {
                const payload = JSON.stringify(scenesArray);
                console.log("[index] Sending payload to Unity:", payload);
                unityInstance.SendMessage("FirebaseBridge", "OnPreloadDataReceived", payload);
            } catch (err) {
                console.error("[index] SendMessage failed:", err);
            }
        }

        // --- Unity UI setup ---
        const container = document.querySelector("#unity-container");
        const canvas = document.querySelector("#unity-canvas");
        const loadingBar = document.querySelector("#unity-loading-bar");
        const progressBarFull = document.querySelector("#unity-progress-bar-full");
        const fullscreenButton = document.querySelector("#unity-fullscreen-button");
        const warningBanner = document.querySelector("#unity-warning");

        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            const div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type === 'error') div.style = 'background: red; padding: 10px;';
            else if (type === 'warning') {
                div.style = 'background: yellow; padding: 10px;';
                setTimeout(() => {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        // --- Unity Config ---
        const config = {
            dataUrl: "./Build/unity-virtual-tour.data",
            frameworkUrl: "./Build/unity-virtual-tour.framework.js",
            codeUrl: "./Build/unity-virtual-tour.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "INTI International College Penang",
            productName: "INTI Virtual Tour",
            productVersion: "0.1",
            showBanner: unityShowBanner
        };

        // Handle mobile scaling
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            const meta = document.createElement('meta');
            meta.name = 'viewport';
            meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
            document.head.appendChild(meta);
            container.className = "unity-mobile";
            canvas.className = "unity-mobile";
            config.devicePixelRatio = 1;
        }

        loadingBar.style.display = "block";

        // Wait a short moment to ensure loader registered createUnityInstance
        setTimeout(() => {
            createUnityInstance(canvas, config, (progress) => {
                progressBarFull.style.width = (100 * progress) + "%";
            }).then((unityInstance) => {
                loadingBar.style.display = "none";
                if (fullscreenButton) {
                    fullscreenButton.onclick = () => unityInstance.SetFullscreen(1);
                }

                fetchScenesArray().then((scenes) => {
                    sendScenesToUnity(unityInstance, scenes);
                });
            }).catch((message) => {
                console.error("Unity failed to start:", message);
            });
        }, 300); // small delay to let loader define the function
    });
    </script>

</body>
</html>
