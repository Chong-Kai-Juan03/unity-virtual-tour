<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | INTI International College Penang</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width="1400" height="880" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">INTI International College Penang</div>
        </div>
    </div>

    <!-- Firebase (prod uses injected config via workflow) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-check-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // -------- Firebase init (prod via FIREBASE_CONFIG) --------
            if (window.FIREBASE_CONFIG) {
                try {
                    firebase.initializeApp(window.FIREBASE_CONFIG);
                    console.log('Firebase initialized');
                    if (window.APP_CHECK_SITE_KEY) {
                        firebase.appCheck().activate(window.APP_CHECK_SITE_KEY, true);
                        console.log('App Check activated');
                    }
                } catch (e) { console.error('Firebase init error:', e); }
            }
            // (For local dev you can comment out the above and paste your inline firebaseConfig)

            // ---- Helpers (unchanged) ----
            function normalizeScenes(root) {
                const out = [];
                if (!root || typeof root !== "object") return out;
                for (const building of Object.keys(root)) {
                    const bObj = root[building];
                    if (!bObj || typeof bObj !== "object") continue;
                    const childKeys = Object.keys(bObj);
                    if (childKeys.length === 0) continue;
                    const firstChild = bObj[childKeys[0]];
                    const hasLevels = firstChild && typeof firstChild === "object" &&
                        !("SceneTitle" in firstChild) && !("ImageUrl" in firstChild);
                    if (hasLevels) {
                        for (const levelName of childKeys) {
                            const levelObj = bObj[levelName];
                            if (!levelObj || typeof levelObj !== "object") continue;
                            for (const itemKey of Object.keys(levelObj)) {
                                const item = levelObj[itemKey] || {};
                                const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                                if (k && u) out.push({ Id: String(itemKey), SceneTitle: String(t || ""), S3Key: String(k), ImageUrl: String(u), Building: String(building), Level: String(levelName) });
                            }
                        }
                    } else {
                        for (const itemKey of childKeys) {
                            const item = bObj[itemKey] || {};
                            const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                            if (k && u) out.push({ Id: String(itemKey), SceneTitle: String(t || ""), S3Key: String(k), ImageUrl: String(u), Building: String(building), Level: "" });
                        }
                    }
                }
                out.sort((a, b) => (a.Building || "").localeCompare(b.Building || "") || (a.Level || "").localeCompare(b.Level || "") || (a.SceneTitle || "").localeCompare(b.SceneTitle || ""));
                return out;
            }

            async function fetchScenesArray() {
                try {
                    const snap = await firebase.database().ref("Scenes").get();
                    if (!snap.exists()) return [];
                    return normalizeScenes(snap.val());
                } catch (err) { console.error("[index] Firebase read failed:", err); return []; }
            }

            function sendScenesToUnity(unityInstance, scenesArray) {
                try {
                    const payload = JSON.stringify(scenesArray);
                    unityInstance.SendMessage("FirebaseBridge", "OnPreloadDataReceived", payload);
                } catch (err) { console.error("[index] SendMessage failed:", err); }
            }

            // -------- Unity boot (Unity default flow) --------
            var container = document.querySelector("#unity-container");
            var canvas = document.querySelector("#unity-canvas");
            var loadingBar = document.querySelector("#unity-loading-bar");
            var progressBarFull = document.querySelector("#unity-progress-bar-full");
            var fullscreenButton = document.querySelector("#unity-fullscreen-button");
            var warningBanner = document.querySelector("#unity-warning");

            function unityShowBanner(msg, type) {
                function updateBannerVisibility() {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                }
                var div = document.createElement('div');
                div.innerHTML = msg;
                warningBanner.appendChild(div);
                if (type == 'error') div.style = 'background: red; padding: 10px;';
                else {
                    if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                    setTimeout(function () { warningBanner.removeChild(div); updateBannerVisibility(); }, 5000);
                }
                updateBannerVisibility();
            }

            // --- Choose which bundle ---
            var buildUrl = "Build";
            var buildName = "newbuild";    // <-- GitHub/prod uses newbuild.*.unityweb
            // var buildName = "output";    // <-- local/dev if you want to test locally

            var loaderUrl = buildUrl + "/" + buildName + ".loader.js?v=10"; // cache-bust if needed
            var config = {
                dataUrl: buildUrl + "/" + buildName + ".data.unityweb",
                frameworkUrl: buildUrl + "/" + buildName + ".framework.js.unityweb",
                codeUrl: buildUrl + "/" + buildName + ".wasm.unityweb",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "INTI International College Penang ",
                productName: "INTI International College Penang",
                productVersion: "0.1",
                decompressionFallback: true,          // required for GitHub Pages
                showBanner: unityShowBanner
                // webglContextAttributes: { alpha: true } // enable if you want page bg to show through
            };

            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.getElementsByTagName('head')[0].appendChild(meta);
                container.className = "unity-mobile";
                canvas.className = "unity-mobile";
                // config.devicePixelRatio = 1; // optional for performance
            } else {
                // Desktop style: fixed window (Unity default)
                canvas.style.width = "1400px";
                canvas.style.height = "880px";
            }

            loadingBar.style.display = "block";

            // fetch Firebase data in parallel (does not block loader)
            const firebasePromise = fetchScenesArray().catch(() => []);

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = (100 * progress) + "%";
                }).then(async (unityInstance) => {
                    loadingBar.style.display = "none";
                    if (fullscreenButton) fullscreenButton.onclick = () => { unityInstance.SetFullscreen(1); };

                    const scenes = await firebasePromise.then(v => v || []);
                    sendScenesToUnity(unityInstance, scenes);

                }).catch((message) => {
                    loadingBar.style.display = "none";
                    alert(message);
                });
            };
            document.body.appendChild(script);
        });
    </script>
</body>
</html>
