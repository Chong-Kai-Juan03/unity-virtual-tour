<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | INTI International College Penang</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        /* Remove margins and force a light background (no black) */
        html, body {
            height: 100%;
            margin: 0;
            background: #ffffff;
        }
        /* Full-bleed container */
        #unity-container {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            background: #ffffff;
        }
        /* Full-bleed canvas; transparent so the white shows through while loading */
        #unity-canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
            background: transparent !important;
            outline: none;
        }
        /* Keep the loader/footer positioned */
        #unity-loading-bar, #unity-footer, #unity-warning {
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">INTI International College Penang</div>
        </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-check-compat.js"></script>

    <!-- Config generated at deploy-time -->
    <script src="firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            /* ---------- Firebase init ---------- */
            const cfg = (window && window.FIREBASE_CONFIG) || null;
            if (!cfg) {
                console.error('Missing Firebase config. Did deploy create firebase-config.js?');
            } else {
                try {
                    firebase.initializeApp(cfg);
                    console.log('Firebase initialized');
                    if (window.APP_CHECK_SITE_KEY) {
                        firebase.appCheck().activate(window.APP_CHECK_SITE_KEY, true);
                        console.log('App Check activated');
                    }
                } catch (e) { console.error('Firebase init error:', e); }
            }

            const LEVEL_FOR_BUILDINGS_WITHOUT_LEVELS = "N/A";

            function normalizeScenes(root) {
                const out = [];
                if (!root || typeof root !== "object") return out;
                for (const building of Object.keys(root)) {
                    const bObj = root[building];
                    if (!bObj || typeof bObj !== "object") continue;
                    const childKeys = Object.keys(bObj);
                    if (childKeys.length === 0) continue;
                    const firstChild = bObj[childKeys[0]];
                    const hasLevels = firstChild && typeof firstChild === "object" &&
                        !("SceneTitle" in firstChild) && !("ImageUrl" in firstChild);
                    if (hasLevels) {
                        for (const levelName of childKeys) {
                            const levelObj = bObj[levelName];
                            if (!levelObj || typeof levelObj !== "object") continue;
                            for (const itemKey of Object.keys(levelObj)) {
                                const item = levelObj[itemKey] || {};
                                const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                                if (k && u) out.push({ Id: String(itemKey), SceneTitle: String(t || ""), S3Key: String(k), ImageUrl: String(u), Building: String(building), Level: String(levelName) });
                            }
                        }
                    } else {
                        for (const itemKey of childKeys) {
                            const item = bObj[itemKey] || {};
                            const t = item.SceneTitle, k = item.S3Key, u = item.ImageUrl;
                            if (k && u) out.push({ Id: String(itemKey), SceneTitle: String(t || ""), S3Key: String(k), ImageUrl: String(u), Building: String(building), Level: "" });
                        }
                    }
                }
                out.sort((a, b) => (a.Building || "").localeCompare(b.Building || "") || (a.Level || "").localeCompare(b.Level || "") || (a.SceneTitle || "").localeCompare(b.SceneTitle || ""));
                return out;
            }

            async function fetchScenesArray() {
                try {
                    const snap = await firebase.database().ref("Scenes").get();
                    if (!snap.exists()) return [];
                    return normalizeScenes(snap.val());
                } catch (err) { console.error("[index] Firebase read failed:", err); return []; }
            }

            function sendScenesToUnity(unityInstance, scenesArray) {
                try {
                    const payload = JSON.stringify(scenesArray);
                    unityInstance.SendMessage("FirebaseBridge", "OnPreloadDataReceived", payload);
                } catch (err) { console.error("[index] SendMessage failed:", err); }
            }

            /* ---------- Unity boot ---------- */
            var container = document.querySelector("#unity-container");
            var canvas = document.querySelector("#unity-canvas");
            var loadingBar = document.querySelector("#unity-loading-bar");
            var progressBarFull = document.querySelector("#unity-progress-bar-full");
            var fullscreenButton = document.querySelector("#unity-fullscreen-button");

            // Fullscreen mobile meta
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.head.appendChild(meta);
            }

            loadingBar.style.display = "block";

            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/newbuild.loader.js?v=6"; // bump to break cache
            var config = {
                dataUrl: buildUrl + "/newbuild.data.unityweb",
                frameworkUrl: buildUrl + "/newbuild.framework.js.unityweb",
                codeUrl: buildUrl + "/newbuild.wasm.unityweb",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "INTI College",
                productName: "INTI Virtual Tour",
                productVersion: "1.0",
                devicePixelRatio: Math.min(1.5, window.devicePixelRatio || 1),
                decompressionFallback: true,
                // allow page background to show through if your camera uses alpha
                webglContextAttributes: { alpha: true }
            };

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = (100 * progress) + "%";
                }).then((unityInstance) => {
                    loadingBar.style.display = "none";
                    if (fullscreenButton) fullscreenButton.onclick = () => unityInstance.SetFullscreen(1);
                    fetchScenesArray().then(scenes => sendScenesToUnity(unityInstance, scenes));
                }).catch((message) => { alert(message); });
            };
            document.body.appendChild(script);
        });
    </script>
</body>
</html>
